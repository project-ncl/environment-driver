quarkus:
  shutdown:
    timeout: 30
  log:
    category:
      "org.jboss.pnc":
        level: DEBUG
    console:
      format: "%d{HH:mm:ss,SSS} %-5p [%c{3.}] (%t) %s%e mdc:[%X]%n"
#  kubernetes-client:
    #namespace: default
    #token: secretToken
oidc:
    auth-server-url: https://keycloak-host/auth/realms/pncredhat
    client-id: client
    credentials:
      secret: secret
    tls:
      verification: none
    keycloak:
      policy-enforcer:
        enable: false

environment-driver:
  working-directory: /tmp
  self-base-url: http://localhost:8081/
  openshift:
    pod: |
      kind: Pod
      apiVersion: v1
      metadata:
        name: "%{pod-name}"
        labels:
          pnc-build-agent-pod: "%{pod-name}"
          environment: "%{environment-label}"
      spec:
        nodeSelector:
          acceptpncbuildagent: 'true'
        containers:
          - name: pnc-build-agent-container
            image: "%{image}"
            ports:
              - name: http
                containerPort: %{containerPort}
                protocol: TCP
            env:
              - name: firewallAllowedDestinations
                value: "%{firewallAllowedDestinations}"
              - name: allowedHttpOutgoingDestinations
                value: "%{allowedHttpOutgoingDestinations}"
              - name: isHttpActive
                value: "%{isHttpActive}"
              - name: proxyServer
                value: "%{proxyServer}"
              - name: proxyPort
                value: "%{proxyPort}"
              - name: nonProxyHosts
                value: "%{nonProxyHosts}"
              - name: proxyUsername
                value: "%{proxyUsername}"
              - name: AProxDependencyUrl
                value: "%{AProxDependencyUrl}"
              - name: AProxDeployUrl
                value: "%{AProxDeployUrl}"
              - name: buildAgentContextPath
                value: "%{buildAgentContextPath}"
              - name: buildAgentBindPort
                value: "%{containerPort}"
              - name: workerUserPassword
                value: "%{workerUserPassword}"
              - name: accessToken
                value: "%{accessToken}"
              - name: logUserId
                value: "%{logUserId}"
              - name: logProcessContext
                value: "%{logProcessContext}"
              - name: buildContentId
                value: "%{buildContentId}"
              - name: buildAgentArguments
                value: "-b 0.0.0.0 -p %{containerPort} -pl FILE -l /tmp -c %{buildAgentContextPath}"
              - name: buildAgentJvmProperties
                value: "-DlogMDC=processContext:%{logProcessContext};tmp:%{tempBuild};exp:%{expiresDate}"
            resources:
              requests:
                cpu: 2000m
                memory: "%{resourcesMemory}"
              limits:
                cpu: 2000m
                memory: "%{resourcesMemory}"
            terminationMessagePath: "/dev/termination-log"
            securityContext:
              capabilities:
                add:
                  - NET_ADMIN
          - name: sidecar
            image: "quay.io/factory2/indy-sidecar:1.0.0"
            volumeMounts:
              - mountPath: "/deployments/config/proxy.yaml"
                readOnly: true
                name: "sidecar-config"
                subPath: "proxy.yaml"
              - mountPath: "/deployments/config/application.yaml"
                readOnly: true
                name: "sidecar-config"
                subPath: "application.yaml"
            env:
              - name: JAVA_OPTS
                value: "-Xms3G -Xmx3G -Xss256k"
            resources:
              requests:
                cpu: 2000m
                memory: 4Gi
              limits:
                cpu: 2000m
                memory: 4Gi
            readinessProbe:
              httpGet:
                path: "/q/health"
                port: 8080
              failureThreshold: 10
              periodSeconds: 30
              timeoutSeconds: 10
        restartPolicy: Never
        activeDeadlineSeconds: 86400
        dnsPolicy: ClusterFirst
        volumes:
          - name: "sidecar-config"
            configMap:
              defaultMode: 420
              name: "indy-master-sidecar-config"
    service: |
      kind: Service
      apiVersion: v1
      metadata:
        name: "%{service-name}"
        labels:
          environment: "%{environment-label}"
      spec:
        ports:
          - name: 8080-tcp
            protocol: TCP
            port: 80
            targetPort: %{containerPort}
            nodePort: 0
        selector:
          pnc-build-agent-pod: "%{pod-name}"
      status:
        loadBalancer:
    ssh-service: |
      kind: Service
      apiVersion: v1
      metadata:
        name: "%{ssh-service-name}"
        labels:
          environment: "%{environment-label}"
      spec:
        ports:
          - name: 2222-ssh
            protocol: TCP
            port: 2222
            targetPort: 2222
            nodePort: 0
        selector:
          pnc-build-agent-pod: "%{pod-name}"
        type: NodePort
      status:
        loadBalancer:
    route: |
      kind: Route
      apiVersion: v1
      metadata:
        name: "%{route-name}"
      spec:
        host: "%{build-agent-host}"
        path: "%{route-path}"
        to:
          kind: Service
          name: "%{service-name}"

"%test":
  quarkus:
    oidc:
      enabled: false
  environment-driver:
    http-client:
      connect-timeout: 1
      request-timeout: 3
    build-agent:
      ping-path: PingHandler
      running-wait-for: 3
    openshift:
      pod: |
        kind: Pod
        apiVersion: v1
        metadata:
          name: "%{pod-name}"
          labels:
            pnc-build-agent-pod: "%{pod-name}"
            environment: "%{environment-label}"
        status:
          phase: Running
        spec:
          nodeSelector:
            acceptpncbuildagent: 'true'
          containers:
            - name: pnc-build-agent-container
              image: "%{image}"
              ports:
                - name: http
                  containerPort: %{containerPort}
                  protocol: TCP
              env:
                - name: firewallAllowedDestinations
                  value: "%{firewallAllowedDestinations}"
                - name: allowedHttpOutgoingDestinations
                  value: "%{allowedHttpOutgoingDestinations}"
                - name: isHttpActive
                  value: "%{isHttpActive}"
                - name: proxyServer
                  value: "%{proxyServer}"
                - name: proxyPort
                  value: "%{proxyPort}"
                - name: nonProxyHosts
                  value: "%{nonProxyHosts}"
                - name: proxyUsername
                  value: "%{proxyUsername}"
                - name: AProxDependencyUrl
                  value: "%{AProxDependencyUrl}"
                - name: AProxDeployUrl
                  value: "%{AProxDeployUrl}"
                - name: buildAgentContextPath
                  value: "%{buildAgentContextPath}"
                - name: buildAgentBindPort
                  value: "%{containerPort}"
                - name: workerUserPassword
                  value: "%{workerUserPassword}"
                - name: accessToken
                  value: "%{accessToken}"
                - name: logUserId
                  value: "%{logUserId}"
                - name: logProcessContext
                  value: "%{logProcessContext}"
                - name: buildContentId
                  value: "%{buildContentId}"
                - name: buildAgentArguments
                  value: "-b 0.0.0.0 -p %{containerPort} -pl FILE -l /tmp -c %{buildAgentContextPath}"
                - name: buildAgentJvmProperties
                  value: "-DlogMDC=processContext:%{logProcessContext};tmp:%{tempBuild};exp:%{expiresDate}"
              resources:
              terminationMessagePath: "/dev/termination-log"
              imagePullPolicy: Always
              securityContext:
                capabilities:
                  add:
                    - NET_ADMIN
          restartPolicy: Never
          activeDeadlineSeconds: 28800
          dnsPolicy: ClusterFirst
      service: |
        kind: Service
        apiVersion: v1
        metadata:
          name: "%{service-name}"
          labels:
            environment: "%{environment-label}"
        spec:
          ports:
            - name: 8080-tcp
              protocol: TCP
              port: 8082
              targetPort: %{containerPort}
              nodePort: 0
          clusterIP: 127.0.0.1

